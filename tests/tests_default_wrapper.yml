---
- name: Run tests_default.yml in check_mode
  hosts: all

  tasks:
    - block:
        - name: create temporary file
          tempfile:
            state: file
            suffix: .yaml
          register: tempinventory

        - name: Get os version of the control node
          command: "hostnamectl"
          register: __result

        - name: Ensure required packages exist
          package:
            name:
              - python3-libselinux
              - policycoreutils
            state: present
          when: __result.stdout is
                  search("Operating System. Red Hat Enterprise Linux 9.*")
                or __result.stdout is
                  search("Operating System. CentOS Linux 9.*")
          delegate_to: localhost

        - name: Create static inventory from hostvars
          template:
            src: inventory.yaml.j2
            dest: "{{ tempinventory.path }}"
            mode: "0644"
          delegate_to: localhost

        - name: Run ansible-playbook with tests_default.yml in check mode
          command: >-
            ansible-playbook -vvv -i {{ tempinventory.path }}
            --check tests_default.yml
          delegate_to: localhost

      always:
        - name: remove the temporary file
          file:
            path: "{{ tempinventory.path }}"
            state: absent
          when: tempinventory.path is defined
          delegate_to: localhost
